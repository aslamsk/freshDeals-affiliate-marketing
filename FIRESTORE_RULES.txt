# Firestore Security Rules for FreshDeals
# This enables frontend admin operations while protecting data

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check admin secret
    function isAdmin() {
      return request.auth.token.admin == true;
    }
    
    // Products collection
    match /products/{productId} {
      // Public read
      allow read: if true;
      
      // Admin write
      allow create, update, delete: if isAdmin();
    }
    
    // Platform prices subcollection
    match /products/{productId}/platformPrices/{priceId} {
      // Public read
      allow read: if true;
      
      // Admin write
      allow create, update, delete: if isAdmin();
    }
    
    // Deals collection
    match /deals/{dealId} {
      // Public read
      allow read: if true;
      
      // Admin write
      allow create, update, delete: if isAdmin();
      
      // Anyone can increment clicks
      allow update: if request.resource.data.clicks == resource.data.clicks + 1;
    }
    
    // Coupons collection
    match /coupons/{couponId} {
      // Public read
      allow read: if true;
      
      // Admin write
      allow create, update, delete: if isAdmin();
    }
    
    // Settings collection
    match /settings/{settingId} {
      // Public read
      allow read: if true;
      
      // Admin write
      allow create, update, delete: if isAdmin();
    }
    
    // Analytics collection
    match /analytics/{analyticsId} {
      // Public write for tracking
      allow create, update: if true;
      
      // Admin read
      allow read: if isAdmin();
    }
    
    // Users collection
    match /users/{userId} {
      // Users can read own data
      allow read, write: if request.auth.uid == userId;
      
      // Admin can read all
      allow read: if isAdmin();
    }
  }
}
